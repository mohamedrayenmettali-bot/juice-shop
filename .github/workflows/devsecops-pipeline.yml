name: DevSecOps CI/CD Pipeline

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
      - develop

env:
  NODE_VERSION: '20.x'
  DOCKER_IMAGE_NAME: juice-shop

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Run linting
        run: npm run lint
        continue-on-error: true

      - name: Run unit tests
        run: npm test
        continue-on-error: true

      - name: Build application
        run: npm run build:server

      - name: Build Docker image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} .
          docker save ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} -o juice-shop-image.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: juice-shop-image.tar
          retention-days: 1

  sast:
    name: SAST - Static Application Security Testing
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies for SonarQube
        run: npm install

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        continue-on-error: true

      - name: Set up Python for Bandit
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit scan
        run: |
          bandit -r . -f json -o bandit-results.json || true
        continue-on-error: true

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep scan
        run: |
          semgrep --config auto --json --output semgrep-results.json || true
        continue-on-error: true

      - name: Upload SAST artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sast-results
          path: |
            bandit-results.json
            semgrep-results.json
          retention-days: 7

  sca:
    name: SCA - Software Composition Analysis
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i juice-shop-image.tar

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-fs-results.json'
        continue-on-error: true

      - name: Run Trivy Docker image scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: '${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}'
          format: 'json'
          output: 'trivy-image-results.json'
        continue-on-error: true

      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'juice-shop'
          path: '.'
          format: 'XML'
          out: '.'
        continue-on-error: true

      - name: Upload SCA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sca-results
          path: |
            trivy-fs-results.json
            trivy-image-results.json
            dependency-check-report.xml
          retention-days: 7

  dast:
    name: DAST - Dynamic Application Security Testing
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i juice-shop-image.tar

      - name: Start Juice Shop container
        run: |
          docker run -d --name juice-shop -p 3000:3000 ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          echo "Waiting for application to start..."
          for i in {1..30}; do
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "Application is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 5
          done

      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          cmd_options: '-j'
        continue-on-error: true

      - name: Convert ZAP report to JSON
        run: |
          if [ -f report_html.html ]; then
            echo '{"zap_version":"baseline","scan_results":"completed"}' > zap-results.json
          fi
        continue-on-error: true

      - name: Stop Juice Shop container
        if: always()
        run: docker stop juice-shop && docker rm juice-shop

      - name: Upload DAST artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dast-results
          path: |
            zap-results.json
            report_html.html
          retention-days: 7

  defectdojo-upload:
    name: DefectDojo Upload
    runs-on: ubuntu-latest
    needs: [sast, sca, dast]
    if: always() && secrets.DEFECTDOJO_URL != '' && secrets.DEFECTDOJO_API_TOKEN != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download SAST artifacts
        uses: actions/download-artifact@v4
        with:
          name: sast-results
        continue-on-error: true

      - name: Download SCA artifacts
        uses: actions/download-artifact@v4
        with:
          name: sca-results
        continue-on-error: true

      - name: Download DAST artifacts
        uses: actions/download-artifact@v4
        with:
          name: dast-results
        continue-on-error: true

      - name: List downloaded artifacts
        run: ls -la

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run DefectDojo upload script
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_TOKEN: ${{ secrets.DEFECTDOJO_API_TOKEN }}
          PRODUCT_NAME: "OWASP Juice Shop"
          PRODUCT_DESCRIPTION: "OWASP Juice Shop - Automated DevSecOps Pipeline"
          ENGAGEMENT_NAME: "CI/CD Run - ${{ github.run_id }}"
          BUILD_ID: "${{ github.run_id }}"
          COMMIT_HASH: "${{ github.sha }}"
          BRANCH_TAG: "${{ github.ref_name }}"
          SOURCE_CODE_MANAGEMENT_URI: "${{ github.server_url }}/${{ github.repository }}"
        run: |
          chmod +x .github/scripts/defectdojo-upload.sh
          .github/scripts/defectdojo-upload.sh
        continue-on-error: true

      - name: Upload summary
        run: |
          echo "## DefectDojo Integration Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Product**: OWASP Juice Shop" >> $GITHUB_STEP_SUMMARY
          echo "- **Engagement**: CI/CD Run - ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.DEFECTDOJO_URL }}" ]; then
            echo "- **View Results**: ${{ secrets.DEFECTDOJO_URL }}" >> $GITHUB_STEP_SUMMARY
          fi
